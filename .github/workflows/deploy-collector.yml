# .github/workflows/deploy-master.yml
name: Deploy to cloudtype

on:
  push:
    branches: [ master ]
  schedule:
    - cron: "50 22 * * *"
    - cron: "55 22 * * *"
    - cron: "*/5 23 * * *"
    - cron: "0 0 * * *"
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: cloudtype-deploy-worker
      cancel-in-progress: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Heartbeat check — schedule only
        id: hb
        if: ${{ github.event_name == 'schedule' }}
        env:
          PGHOST:     ${{ secrets.PGHOST }}
          PGPORT:     ${{ secrets.PGPORT }}
          PGUSER:     ${{ secrets.PGUSER }}
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
          PGDATABASE: ${{ secrets.PGDATABASE }}
          FRESH_MIN: "6"
        run: |
          if ! command -v psql >/dev/null 2>&1; then
            sudo apt-get update -y && sudo apt-get install -y postgresql-client
          fi
          SQL=$'SELECT NOW() - MAX(ts) <= make_interval(mins => '"${FRESH_MIN}"') AS is_fresh FROM worker_heartbeat;'
          set +e
          RES=$(psql "host=$PGHOST port=$PGPORT user=$PGUSER dbname=$PGDATABASE" -At -c "$SQL" 2>/dev/null)
          EC=$?
          set -e
          echo "psql exit=$EC, result=${RES}"
          if [ $EC -ne 0 ] || [ "$RES" != "t" ]; then
            echo "heartbeat=failure" >> $GITHUB_OUTPUT
          else
            echo "heartbeat=success" >> $GITHUB_OUTPUT
          fi

      - name: Connect deploy key
        if: github.event_name == 'push' || steps.hb.outputs.heartbeat == 'failure'
        uses: cloudtype-github-actions/connect@v1
        with:
          token: ${{ secrets.CLOUDTYPE_TOKEN }}
          ghtoken: ${{ secrets.GHP_TOKEN }}

      - name: Deploy to Cloudtype
        if: github.event_name == 'push' || steps.hb.outputs.heartbeat == 'failure'
        uses: cloudtype-github-actions/deploy@v1
        with:
          token: ${{ secrets.CLOUDTYPE_TOKEN }}
          project: ekumartin/kiwoom_api
          stage: main
          yaml: |
            name: kiwoom-api
            app: dockerfile
            options:
              dockerfile: 파이썬/api/Dockerfile.dockerfile
              env:
                - name: PGHOST
                  value: svc.sel3.cloudtype.app
                - name: PGPORT
                  value: "31312"
                - name: PGUSER
                  value: root
                - name: PGDATABASE
                  value: postgres
                - name: PGPASSWORD
                  secret: PGPASSWORD
                - name: API_APPKEY
                  secret: API_APPKEY
                - name: API_SECRETKEY
                  secret: API_SECRETKEY
                - name: PYTHONUTF8
                  value: "1"
                - name: PYTHONIOENCODING
                  value: UTF-8
                - name: LANG
                  value: C.UTF-8
                - name: LC_ALL
                  value: C.UTF-8
              args: []
              commands: >
                bash -lc 'python - <<PY from pathlib import Path
                Path("/tmp/a.py").write_text(open("/app/api_call.py","rb").read().decode("utf-8","ignore"),
                encoding="utf-8") PY && pip -q install -t /tmp/p pydantic &&
                PYTHONPATH=/tmp/p python -u /tmp/a.py'
            context:
              git:
                url: git@github.com:${{ github.repository }}.git
                ref: refs/heads/master

      - name: Already running — skipped
        if: ${{ github.event_name == 'schedule' && steps.hb.outputs.heartbeat == 'success' }}
        run: echo "Worker heartbeat is fresh. Skipping deploy."
